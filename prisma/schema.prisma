generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id         String   @id @default(cuid())
  name       String
  phone      String?
  email      String?
  address    String?
  city       String?
  district   String?
  state      String?
  country    String?
  zipCode    String?
  
  // Relations
  companyRoles CompanyRole[]   @relation("CompaniesRoles")
  companyUsers CompanyUser[]   @relation("CompanyUsers")
  shifts       Shift[]         @relation("CompanyShifts")
  attendances  Attendance[]    @relation("CompanyAttendances")
  companyOffs  CompanyOff[]    @relation("CompanyOffs")
  offDays      OffDay[]        @relation("CompanyOffsOffDays")
  leaveTypeAllocation LeaveTypeAllocation? @relation("CompanyLeaveTypeAllocation")
  leaves       Leave[]         @relation("CompanyLeaves")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("companies")
}

model CompanyUser {
  id String @id @default(cuid())

  // Relations
  userId    String
  user      User    @relation("UserCompanyUser", fields: [userId], references: [id], onDelete: Cascade)
  companyId String
  company   Company @relation("CompanyUsers", fields: [companyId], references: [id], onDelete: Cascade)

  // Role assignment
  roleId String?
  role   CompanyRole? @relation("CompanyUserRole", fields: [roleId], references: [id])

  firstName  String?
  middleName String?
  lastName   String?
  
  // Status
  status     CompanyUserStatus @default(PENDING)
  isActive   Boolean           @default(true)

  // Relations to Shift
  createdShifts Shift[]                          @relation("ShiftCreatedBy")
  shiftAssignments ShiftAttributeAssignment[]    @relation("ShiftAttributeAssignee")

  // Relations to Attendance
  attendances Attendance[] @relation("CompanyUserAttendances")

  // Relations to Off Days
  createdOffDays OffDay[]    @relation("OffDayCreatedBy")
  usersOffs      UsersOff[]  @relation("UsersOffAssignee")

  // Relations to Leave System
   usersLeaveRecords UsersLeaveRecord[] @relation("CompanyUserLeaveRecords")
  createdLeaveAllocations LeaveTypeAllocation[] @relation("LeaveAllocationCreatedBy")
  leavesApplied Leave[] @relation("UserLeaves")
  leavesApproved Leave[] @relation("ApprovedLeaves")
  comments      Comment[] @relation("UserComments")
  attachments   Attachment[] @relation("UserAttachments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, companyId])
  @@map("company_users")
}

model User {
  id    String @id @default(cuid())
  email String @unique
  
  // Relation to CompanyUser
  companyUsers CompanyUser[] @relation("UserCompanyUser")
  
  // Relation to Attendance
  attendances Attendance[] @relation("UserAttendances")

  // Relation to Leave System
  usersLeaveRecords UsersLeaveRecord[] @relation("UserLeaveRecords")

  @@map("users")
}

model CompanyRole {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Relations
  companyId String  
  company   Company @relation("CompaniesRoles", fields: [companyId], references: [id], onDelete: Cascade)
  
  // Users with this role
  companyUsers CompanyUser[] @relation("CompanyUserRole")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
  @@map("company_roles")
}

enum CompanyUserStatus {
  PENDING
  ACTIVE
  INACTIVE
  SUSPENDED
}

model Shift {
  id               String            @id @default(cuid())
  companyId        String
  shiftCreatedBy   String
  
  // Relations
  company          Company           @relation("CompanyShifts", fields: [companyId], references: [id], onDelete: Cascade)
  shiftAttributes  ShiftAttribute[]  @relation("ShiftAttributes")
  createdBy        CompanyUser       @relation("ShiftCreatedBy", fields: [shiftCreatedBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("shifts")
}

model ShiftAttribute {
  id                 String   @id @default(cuid())
  shiftId            String
  shiftName          String
  startTime          DateTime
  endTime            DateTime
  breakDuration      Int?     
  gracePeriodMinutes Int?     
  description        String?
  color              String?  
  isActive           Boolean  @default(true)

  // Relations
  shift       Shift                       @relation("ShiftAttributes", fields: [shiftId], references: [id], onDelete: Cascade)
  assignments ShiftAttributeAssignment[]  @relation("ShiftAttributeAssignments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("shift_attributes")
}

model ShiftAttributeAssignment {
  id                 String  @id @default(cuid())
  shiftAttributeId   String
  assignedUserId     String  

  // Relations
  shiftAttribute ShiftAttribute @relation("ShiftAttributeAssignments", fields: [shiftAttributeId], references: [id], onDelete: Cascade)
  assignedUser   CompanyUser    @relation("ShiftAttributeAssignee", fields: [assignedUserId], references: [id], onDelete: Cascade)

  assignedAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([shiftAttributeId, assignedUserId])
  @@map("shift_attribute_assignments")
}

model Attendance {
  id           String   @id @default(cuid()) 
  companyId    String
  userId       String
  companyUserId String? 

  // Punch records
  userPunches  UserPunch[] @relation("AttendanceUserPunches") 
  punchDate    DateTime
  totalWorkHours Float?    
  totalOvertime  Float?    
  finalStatus    AttendanceStatus @default(PRESENT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company     Company     @relation("CompanyAttendances", fields: [companyId], references: [id], onDelete: Cascade)
  user        User        @relation("UserAttendances", fields: [userId], references: [id], onDelete: Cascade)
  companyUser CompanyUser? @relation("CompanyUserAttendances", fields: [companyUserId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId, punchDate])
  @@map("attendances")
}

model UserPunch {
  id               String           @id @default(cuid()) 
  attendanceId     String
  punchIn          DateTime
  punchInLocation  String?          
  punchOut         DateTime?
  punchOutLocation String?
  workHours        Float?           
  overtime         Float?          
  status           AttendanceStatus @default(PRESENT)
  remarks          String?
  
  punchType        PunchType        @default(IN) 
  deviceId         String?          
  ipAddress        String?          

  // Relations
  attendance Attendance @relation("AttendanceUserPunches", fields: [attendanceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_punches")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  ON_LEAVE
  HALF_DAY
  LATE
  EARLY_LEAVE
}

enum PunchType {
  IN
  OUT
}

model CompanyOff {
  id          String   @id @default(cuid())
  companyId   String
  weekDay     Int[]
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  company Company  @relation("CompanyOffs", fields: [companyId], references: [id], onDelete: Cascade)
  offDays OffDay[] @relation("CompanyOffDays")
}

model OffDay {
  id           String     @id @default(cuid())
  name         String
  holidayType  String
  fromDate     DateTime
  toDate       DateTime
  startTime    String
  endTime      String
  description  String
  
  companyId    String
  createdById  String
  companyOffId String?

  company    Company     @relation("CompanyOffsOffDays", fields: [companyId], references: [id], onDelete: Cascade)
  createdBy  CompanyUser @relation("OffDayCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  companyOff CompanyOff? @relation("CompanyOffDays", fields: [companyOffId], references: [id], onDelete: Cascade)
  usersOffs  UsersOff[]  @relation("OffDayUsers")
}

model UsersOff {
  id       String @id @default(cuid())
  userId   String
  offDayId String

  // Relations
  user   CompanyUser @relation("UsersOffAssignee", fields: [userId], references: [id], onDelete: Cascade)
  offDay OffDay      @relation("OffDayUsers", fields: [offDayId], references: [id], onDelete: Cascade)

  @@unique([userId, offDayId])
}

// Leave System Models

model LeaveTypeAllocation {
  id        String   @id @default(cuid())
  companyId String   @unique
  
  // Relations
  company        Company          @relation("CompanyLeaveTypeAllocation", fields: [companyId], references: [id], onDelete: Cascade)
  leaveAttributes LeaveAttribute[] @relation("LeaveTypeAllocationAttributes") // Change LeaveAttributes[] to LeaveAttribute[]
  
  createdById String
  createdBy   CompanyUser @relation("LeaveAllocationCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("leave_type_allocations")

}

model LeaveAttribute {
  id                   String   @id @default(cuid())
  leaveTypeAllocationId String
  year                 Int
  leaveName            String
  role                 String
  allocatedDays        Int
  isActive             Boolean  @default(true)
  
  // Relations
  leaveTypeAllocation LeaveTypeAllocation @relation("LeaveTypeAllocationAttributes", fields: [leaveTypeAllocationId], references: [id], onDelete: Cascade)
  usersLeaveRecords   UsersLeaveRecord[]  @relation("LeaveAttributeRecords")
  leaves              Leave[]             @relation("LeaveAttributeLeaves")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([leaveTypeAllocationId, year, leaveName, role])
  @@map("leave_attributes")
}

model UsersLeaveRecord {
  id               String   @id @default(cuid())
  userId           String
  leaveAttributeId String
  year             Int
  usedDays         Int      @default(0)
  remainingDays    Int
  carriedOverDays  Int      @default(0)
  
  // Relations
  user             User               @relation("UserLeaveRecords", fields: [userId], references: [id], onDelete: Cascade)
  leaveAttribute   LeaveAttribute     @relation("LeaveAttributeRecords", fields: [leaveAttributeId], references: [id], onDelete: Cascade)
  carryForwardDays CarryForwardDays[]  @relation("LeaveRecordCarryForwards")
  leaves           Leave[]            @relation("UserLeaveRecordLeaves")
  companyUser      CompanyUser        @relation("CompanyUserLeaveRecords", fields: [companyUserId], references: [id], onDelete: Cascade)

  companyUserId    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, leaveAttributeId, year])
  @@unique([userId, leaveAttributeId]) // Add this line for the composite reference
  @@map("users_leave_records")
}


model CarryForwardDays {
  id                 String           @id @default(cuid())
  days               Int
  year               Int
  usersLeaveRecordId String
  
  // Relations
  usersLeaveRecord UsersLeaveRecord @relation("LeaveRecordCarryForwards", fields: [usersLeaveRecordId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("carry_forward_days")
}

model Leave {
  id          String      @id @default(cuid())
  userId      String
  companyId   String
  leaveTypeId String
  startDate   DateTime
  endDate     DateTime
  status      LeaveStatus @default(PENDING)
  reason      String?
  approverId  String?

  comments    Comment[]     @relation("LeaveComments")
  attachments Attachment[]  @relation("LeaveAttachments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  approver  CompanyUser? @relation("ApprovedLeaves", fields: [approverId], references: [id])
  userLeave CompanyUser  @relation("UserLeaves", fields: [userId], references: [id])
  company   Company      @relation("CompanyLeaves", fields: [companyId], references: [id])
  leaveType LeaveAttribute @relation("LeaveAttributeLeaves", fields: [leaveTypeId], references: [id])
  usersLeaveRecord UsersLeaveRecord? @relation("UserLeaveRecordLeaves", fields: [usersLeaveRecordId], references: [id]) // Change this line

  // Add this field for the relation
  usersLeaveRecordId String?

  @@map("leaves")
}

model Comment {
  id          String   @id @default(uuid())
  userId      String
  leaveId     String
  comment     String
  commentDate DateTime @default(now())

  user  CompanyUser @relation("UserComments", fields: [userId], references: [id], onDelete: Cascade)
  leave Leave       @relation("LeaveComments", fields: [leaveId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("comments")
}

model Attachment {
  id             String   @id @default(uuid())
  userId         String
  leaveId        String
  attachment     String
  fileName       String?
  fileSize       Int?
  mimeType       String?
  attachmentDate DateTime @default(now())

  user  CompanyUser @relation("UserAttachments", fields: [userId], references: [id], onDelete: Cascade)
  leave Leave       @relation("LeaveAttachments", fields: [leaveId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("attachments")
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  IN_REVIEW
}